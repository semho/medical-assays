{% extends 'medical_analysis/base.html' %}
{% load static %}

{% block title %}Обработка анализа{% endblock %}

{% block extra_css %}
<style>
    .processing-container {
        min-height: 60vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .processing-card {
        max-width: 600px;
        width: 100%;
    }
    .spinner-large {
        width: 4rem;
        height: 4rem;
    }
    .progress-text {
        font-size: 1.1rem;
        margin-top: 1rem;
    }
    .file-info {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container processing-container">
    <div class="processing-card">
        <div class="card shadow-lg">
            <div class="card-body text-center p-5">
                <div id="processing-view">
                    <h3 class="mb-4">Обрабатываем ваш анализ</h3>

                    <!-- НОВЫЙ ПРОГРЕСС-БАР -->
                    <div class="mb-4">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 id="progress-bar"
                                 role="progressbar"
                                 style="width: 10%"
                                 aria-valuenow="10"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <span id="progress-percentage">10%</span>
                            </div>
                        </div>
                    </div>

                    <p class="text-primary" id="progress-message">загрузка файла...</p>
                    
                    <div class="file-info mt-4">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-file-alt me-2"></i>Файл
                        </h6>
                        <p class="mb-0"><strong>{{ session.original_filename }}</strong></p>
                        <small class="text-muted">
                            Загружен: {{ session.upload_timestamp|date:"d.m.Y H:i" }}
                        </small>
                    </div>

                    <div class="mt-4">
                        <div class="spinner-grow spinner-grow-sm text-primary me-2" role="status"></div>
                        <div class="spinner-grow spinner-grow-sm text-primary me-2" role="status"></div>
                        <div class="spinner-grow spinner-grow-sm text-primary" role="status"></div>
                    </div>
                </div>

                <div id="error-view" style="display: none;">
                    <i class="fas fa-exclamation-triangle text-danger fa-4x mb-4"></i>
                    <h3 class="text-danger mb-3">Ошибка обработки</h3>
                    <p class="text-muted" id="error-message"></p>
                    <a href="{% url 'upload_file' %}" class="btn btn-primary mt-3">
                        <i class="fas fa-upload me-2"></i>Загрузить другой файл
                    </a>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>
                Ваши данные защищены end-to-end шифрованием
            </small>
        </div>
    </div>
</div>

<script>
// Проверка статуса каждые 2 секунды
const sessionId = {{ session.id }};
let checkInterval;
let checksCount = 0;
const maxChecks = 60; // Максимум 2 минуты ожидания
let currentProgress = 10;

function checkStatus() {
    checksCount++;
    
    if (checksCount > maxChecks) {
        clearInterval(checkInterval);
        showError('Превышено время ожидания обработки. Попробуйте загрузить файл снова.');
        return;
    }

    fetch(`/sessions/${sessionId}/check-status/`)
    .then(response => response.json())
    .then(data => {
        console.log('Status:', data.status, 'Progress:', data.progress);

        const progressBar = document.getElementById('progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        const progressMessage = document.getElementById('progress-message');

        // Плавное увеличение до реального значения
        if (data.progress > currentProgress) {
            const targetProgress = data.progress;
            const step = (targetProgress - currentProgress) / 5; // разбиваем на 5 шагов

            const smoothInterval = setInterval(() => {
                currentProgress += step;
                if (currentProgress >= targetProgress) {
                    currentProgress = targetProgress;
                    clearInterval(smoothInterval);
                }

                progressBar.style.width = currentProgress + '%';
                progressBar.setAttribute('aria-valuenow', currentProgress);
                progressPercentage.textContent = Math.round(currentProgress) + '%';
            }, 100);
        }

        if (progressMessage && data.message) {
            progressMessage.textContent = data.message;
        }

        if (data.status === 'completed') {
            clearInterval(checkInterval);
            currentProgress = 100;
            progressBar.style.width = '100%';
            progressPercentage.textContent = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-success');

            // ИСПРАВЛЕНО: редирект на конкретный анализ
            setTimeout(() => {
                // получаем ID анализа из бэкенда
                fetch(`/sessions/${sessionId}/check-status/`)
                    .then(r => r.json())
                    .then(d => {
                        if (d.analysis_id) {
                            window.location.href = `/results/${d.analysis_id}/`;
                        } else {
                            window.location.href = '/results/';
                        }
                    });
            }, 1500);
        } else if (data.status === 'error') {
            clearInterval(checkInterval);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            showError(data.error_message || 'Произошла ошибка при обработке файла');
        }
    })
}

function showError(message) {
    document.getElementById('processing-view').style.display = 'none';
    document.getElementById('error-view').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

// Начинаем проверку статуса
document.addEventListener('DOMContentLoaded', function() {
    // Первая проверка сразу
    checkStatus();
    // Затем каждые 2 секунды
    checkInterval = setInterval(checkStatus, 2000);
});

// Очистка при уходе со страницы
window.addEventListener('beforeunload', function() {
    if (checkInterval) {
        clearInterval(checkInterval);
    }
});
</script>
{% endblock %}